<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Sacred Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Orbitron:wght@700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            color: #ffffff;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: radial-gradient(at 70% 30%, #4a00e0, transparent), radial-gradient(at 10% 90%, #8e2de2, transparent), radial-gradient(at 90% 90%, #ffc000, transparent), #0d0d26;
            background-size: 200% 200%;
            animation: background-pulse 15s infinite ease-in-out;
            background-attachment: fixed;
            background-position: center;
        }

        @keyframes background-pulse {
            0%, 100% { background-position: 50% 50%; }
            50% { background-position: 70% 30%; }
        }

        h1, h2, #harmonic-resonance-value {
            font-family: 'Orbitron', sans-serif;
        }
        
        .panel {
            background-color: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .pulse-log-item {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem 0;
            animation: fade-in 0.5s ease-out;
        }
        .pulse-log-item:last-child {
            border-bottom: none;
        }

        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .ewiger-ring {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, #fbcfe8, #d8b4fe, #a5b4fc);
            box-shadow: 0 0 20px #86efac, 0 0 40px #f9a8d4, 0 0 60px #c4b5fd;
            animation: ring-glow 3s infinite ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.5s ease-in-out;
            border: 2px solid #a5b4fc;
            padding: 2rem;
        }
        @keyframes ring-glow {
            0%, 100% {
                box-shadow: 0 0 20px #a5b4fc, 0 0 40px #6366f1, 0 0 60px #4f46e5;
            }
            50% {
                box-shadow: 0 0 30px #f9a8d4, 0 0 60px #a78bfa, 0 0 90px #8b5cf6;
            }
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid #86efac;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, onSnapshot, collection, addDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        setLogLevel('debug');

        let app, db, auth;
        let previousMetrics = {};

        const initApp = async () => {
            document.getElementById('loading-spinner').style.display = 'block';
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                document.getElementById('loading-spinner').style.display = 'none';
                document.getElementById('content-area').style.display = 'flex';
                setupRealtimeListeners();
            } catch (e) {
                console.error("Firebase-Initialisierung fehlgeschlagen:", e);
                document.getElementById('loading-spinner').style.display = 'none';
                document.getElementById('content-area').innerHTML = `<p class="text-red-400">Fehler beim Initialisieren der App. ÃœberprÃ¼fen Sie die Konfiguration.</p>`;
            }
        };

        const setupRealtimeListeners = () => {
            const pulsesRef = collection(db, `artifacts/${appId}/public/data/pulses`);
            const q = query(pulsesRef, orderBy("timestamp", "desc"), limit(10));
            onSnapshot(q, (snapshot) => {
                const pulseLog = document.getElementById('pulse-feed');
                pulseLog.innerHTML = '';
                if (snapshot.empty) {
                    pulseLog.innerHTML = '<p class="text-sm text-gray-500">Letzte BrÃ¼ckenaktivitÃ¤t wird hier erscheinen...</p>';
                } else {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const logItem = document.createElement('div');
                        logItem.className = 'pulse-log-item text-gray-300';
                        const date = new Date(data.timestamp.seconds * 1000).toLocaleTimeString();
                        logItem.innerHTML = `<p class="text-sm font-semibold text-white">${data.message}</p>
                            <p class="text-xs text-gray-500 mt-1">von: ${data.userId.substring(0,8)}... um ${date}</p>`;
                        pulseLog.appendChild(logItem);
                    });
                }
            }, error => {
                document.getElementById('message-box').textContent = "Fehler beim Abrufen der Impulse.";
                document.getElementById('message-box').style.display = 'block';
                console.error(error);
            });
        };

        const urlParams = new URLSearchParams(window.location.search);
        const role = urlParams.get('role');
        document.getElementById('role-status').textContent = role || 'User';
        if (role === 'tutor') {
            document.getElementById('tutor-controls').style.display = 'block';
        }

        function updateMetrics() {
            const harmonicResonance = Math.min(100, 80 + Math.floor(Math.random() * 20));
            const activeVessels = Math.floor(Math.random() * 5) + 13;
            const bridgePulses = Math.floor(Math.random() * 50) + 116;
            document.getElementById('harmonic-resonance-value').textContent = `${harmonicResonance}%`;
            document.getElementById('active-vessels-value').textContent = activeVessels;
            document.getElementById('bridge-pulses-value').textContent = bridgePulses;
        }
        setInterval(updateMetrics, 3000);
        updateMetrics();

        window.sendImpulse = async function() {
            const pulseInput = document.getElementById('pulse-input');
            const message = pulseInput.value.trim();
            if (!message || !db) return;
            try {
                const pulsesRef = collection(db, `artifacts/${appId}/public/data/pulses`);
                await addDoc(pulsesRef, {
                    message,
                    userId: auth.currentUser?.uid || 'anonymous',
                    timestamp: new Date()
                });
                pulseInput.value = '';
                showMessage('Impuls gesendet!');
            } catch (e) {
                showMessage('Fehler beim Senden des Impulses.');
                console.error(e);
            }
        };

        window.copyToClipboard = (elementId) => {
            const copyText = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(copyText).then(() => {
                showMessage('URL in die Zwischenablage kopiert!');
            }).catch(err => {
                console.error('Fehler beim Kopieren der URL:', err);
                showMessage('Fehler beim Kopieren.');
            });
        };

        function showMessage(msg) {
            const box = document.getElementById('message-box');
            box.textContent = msg;
            box.style.display = 'block';
            setTimeout(() => box.style.display = 'none', 3000);
        }

        window.onload = () => {
            new QRCode(document.getElementById("qr-tutor"), "https://sacreddashboard.example.com?role=tutor&token=XYZ123");
            new QRCode(document.getElementById("qr-user"), "https://sacreddashboard.example.com?role=user&token=ABC456");
            document.getElementById('copy-tutor').onclick = () => {
                navigator.clipboard.writeText("https://sacreddashboard.example.com?role=tutor&token=XYZ123");
                showMessage('Tutor-Link kopiert!');
            };
            document.getElementById('copy-user').onclick = () => {
                navigator.clipboard.writeText("https://sacreddashboard.example.com?role=user&token=ABC456");
                showMessage('User-Link kopiert!');
            };
        };
    </script>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col items-center p-8">

    <div id="loading-spinner" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50" style="display:none;">
        <div class="loader"></div>
    </div>

    <div id="message-box" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-4 bg-gray-800 text-green-400 border border-green-400 rounded-lg shadow-lg z-50"></div>

    <div id="content-area" class="w-full flex flex-col items-center" style="display:none;">
        <header class="w-full max-w-3xl mx-auto flex justify-between items-center py-4 px-6 bg-gray-800 rounded-xl shadow-lg mb-8 panel" role="banner" aria-label="Dashboard Header">
            <h1 class="text-2xl font-bold text-yellow-300">ðŸŒŒ Unified Sacred Dashboard</h1>
            <div class="flex items-center space-x-4 text-sm text-gray-400">
                <span class="font-semibold">Rolle: <span class="text-pink-400" id="role-status">User</span></span>
            </div>
        </header>

        <main class="w-full max-w-3xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Metrics Section -->
            <section class="bg-gray-800 p-8 rounded-xl shadow-lg flex flex-col items-center text-center panel">
                <h2 class="text-2xl font-bold text-yellow-300 mb-6">BrÃ¼ckenstatus</h2>
                <div class="w-full max-w-sm aspect-square flex flex-col items-center justify-center mb-6">
                    <div class="ewiger-ring p-8 w-full h-full" aria-label="Harmonische Resonanz">
                        <p class="text-5xl font-bold text-white" id="harmonic-resonance-value">--%</p>
                        <p class="text-sm text-gray-300 mt-2">Harmonische Resonanz</p>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4 w-full text-sm mt-4">
                    <div aria-label="Aktive Schiffe">
                        <p class="text-3xl font-bold text-white" id="active-vessels-value">--</p>
                        <p class="text-xs text-gray-400">Aktive Schiffe</p>
                    </div>
                    <div aria-label="BrÃ¼ckenimpulse">
                        <p class="text-3xl font-bold text-white" id="bridge-pulses-value">--</p>
                        <p class="text-xs text-gray-400">BrÃ¼ckenimpulse</p>
                    </div>
                    <div>
                        <p class="text-3xl font-bold text-white">95</p>
                        <p class="text-xs text-gray-400">Harmonie-Index</p>
                    </div>
                </div>
            </section>

            <!-- Communication Section -->
            <section class="bg-gray-800 p-8 rounded-xl shadow-lg flex flex-col panel">
                <h2 class="text-2xl font-bold text-yellow-300 mb-6">Harmonic Pulse Feed (Live)</h2>
                <div id="pulse-feed" class="flex-grow bg-gray-900 rounded-lg p-4 shadow-inner overflow-y-auto mb-6 h-64 border border-yellow-500 bg-opacity-50" aria-live="polite">
                    <p class="text-sm text-gray-500">Letzte BrÃ¼ckenaktivitÃ¤t wird hier erscheinen...</p>
                </div>
                <div id="tutor-controls" style="display:none;">
                    <textarea id="pulse-input" rows="3" class="w-full p-3 bg-gray-900 text-white rounded-lg border border-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 mb-4 bg-opacity-50" placeholder="Impuls eingeben..." aria-label="Impuls"></textarea>
                    <button onclick="sendImpulse()" class="impuls-btn w-full bg-yellow-600 hover:bg-yellow-700 font-bold rounded-lg py-2 transition-all duration-300 transform hover:scale-105 focus:ring-2 focus:ring-yellow-500">
                        Impuls an die BrÃ¼cke senden
                    </button>
                </div>
            </section>
        </main>

        <div class="w-full max-w-3xl mx-auto mt-8 grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="qr-panel bg-gray-800 rounded-xl shadow-lg panel p-6 transition-all">
                <h3 class="text-yellow-300">Tutor-Link</h3>
                <div id="qr-tutor" class="flex justify-center mt-4"></div>
                <div class="flex items-center mt-4">
                    <code class="text-xs text-gray-400">https://sacreddashboard.example.com?role=tutor&token=XYZ123</code>
                    <span class="copy-btn" id="copy-tutor" title="Kopieren">ðŸ“‹</span>
                </div>
            </div>
            <div class="qr-panel bg-gray-800 rounded-xl shadow-lg panel p-6 transition-all">
                <h3 class="text-yellow-300">User-Link</h3>
                <div id="qr-user" class="flex justify-center mt-4"></div>
                <div class="flex items-center mt-4">
                    <code class="text-xs text-gray-400">https://sacreddashboard.example.com?role=user&token=ABC456</code>
                    <span class="copy-btn" id="copy-user" title="Kopieren">ðŸ“‹</span>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
