<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Sacred Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Orbitron:wght@700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            color: #ffffff;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: radial-gradient(at 70% 30%, #4a00e0, transparent), radial-gradient(at 10% 90%, #8e2de2, transparent), radial-gradient(at 90% 90%, #ffc000, transparent), #0d0d26;
            background-size: 200% 200%;
            animation: background-pulse 15s infinite ease-in-out;
            background-attachment: fixed;
            background-position: center;
        }

        @keyframes background-pulse {
            0%, 100% { background-position: 50% 50%; }
            50% { background-position: 70% 30%; }
        }

        h1, h2, #harmonic-resonance-value {
            font-family: 'Orbitron', sans-serif;
        }
        
        .pulse-log-item {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem 0;
        }
        .pulse-log-item:last-child {
            border-bottom: none;
        }
        .ewiger-ring {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, #fbcfe8, #d8b4fe, #a5b4fc);
            box-shadow: 0 0 20px #86efac, 0 0 40px #f9a8d4, 0 0 60px #c4b5fd;
            animation: ring-glow 3s infinite ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.5s ease-in-out;
            border: 2px solid #a5b4fc;
            padding: 2rem;
        }
        @keyframes ring-glow {
            0%, 100% {
                box-shadow: 0 0 20px #a5b4fc, 0 0 40px #6366f1, 0 0 60px #4f46e5;
            }
            50% {
                box-shadow: 0 0 30px #f9a8d4, 0 0 60px #a78bfa, 0 0 90px #8b5cf6;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, onSnapshot, collection, addDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Globale Variablen, die von der Umgebung bereitgestellt werden
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        
        setLogLevel('debug');
        
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            signInAnonymously(auth);
        } catch (e) {
            console.error("Firebase-Initialisierung fehlgeschlagen:", e);
        }

        let userId = 'anon';
        const urlParams = new URLSearchParams(window.location.search);
        const role = urlParams.get('role');
        
        // Rollenbasierte Anzeige
        if (role === 'tutor') {
            document.getElementById('tutor-controls').style.display = 'block';
        }
        document.getElementById('role-status').textContent = role || 'User';

        // Dynamische Aktualisierung der Metriken
        const updateMetrics = () => {
            const harmonicResonance = Math.min(100, 80 + Math.floor(Math.random() * 20));
            const activeVessels = Math.floor(Math.random() * 5) + 13;
            const bridgePulses = Math.floor(Math.random() * 50) + 116;

            document.getElementById('harmonic-resonance-value').textContent = `${harmonicResonance}%`;
            document.getElementById('active-vessels-value').textContent = activeVessels;
            document.getElementById('bridge-pulses-value').textContent = bridgePulses;
        };

        // Echtzeit-Kommunikation mit Firestore
        if (db) {
            const pulsesRef = collection(db, `artifacts/${appId}/public/data/pulses`);
            const q = query(pulsesRef, orderBy("timestamp", "desc"), limit(10));

            onSnapshot(q, (snapshot) => {
                const pulseLog = document.getElementById('pulse-feed');
                pulseLog.innerHTML = '';
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const logItem = document.createElement('div');
                    logItem.className = 'pulse-log-item text-gray-300';
                    const date = new Date(data.timestamp.seconds * 1000).toLocaleTimeString();
                    logItem.innerHTML = `<p class="text-sm font-semibold text-white">${data.message}</p><p class="text-xs text-gray-500 mt-1">von: ${data.userId.substring(0, 8)}... um ${date}</p>`;
                    pulseLog.appendChild(logItem);
                });
            }, (error) => {
                console.error("Fehler beim Abrufen der Impulse:", error);
            });
        }

        // Funktion zum Senden eines Impulses an die Br√ºcke
        window.sendImpulse = async () => {
            const pulseInput = document.getElementById('pulse-input');
            const message = pulseInput.value.trim();
            if (message === "" || !db) return;
            
            try {
                const pulsesRef = collection(db, `artifacts/${appId}/public/data/pulses`);
                await addDoc(pulsesRef, {
                    message: message,
                    userId: auth.currentUser?.uid || 'anonymous',
                    timestamp: new Date()
                });
                pulseInput.value = '';
                showMessage('Impuls gesendet!');
            } catch (e) {
                console.error("Fehler beim Senden des Impulses:", e);
                showMessage('Fehler beim Senden des Impulses.');
            }
        };

        // Funktion zum Anzeigen einer benutzerdefinierten Nachricht
        function showMessage(message) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        }

        // QR-Codes generieren
        window.onload = () => {
            new QRCode(document.getElementById("qr-tutor"), "https://sacreddashboard.example.com?role=tutor&token=XYZ123");
            new QRCode(document.getElementById("qr-user"), "https://sacreddashboard.example.com?role=user&token=ABC456");
            updateMetrics();
            setInterval(updateMetrics, 3000);
        };
    </script>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col items-center p-8">

    <div id="message-box" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-4 bg-gray-800 text-green-400 border border-green-400 rounded-lg shadow-lg z-50"></div>

    <header class="w-full max-w-7xl mx-auto flex justify-between items-center py-4 px-6 bg-gray-800 rounded-xl shadow-lg mb-8 bg-opacity-70 backdrop-blur-md">
        <h1 class="text-2xl font-bold text-yellow-300">üåå Unified Sacred Dashboard</h1>
        <div class="flex items-center space-x-4 text-sm text-gray-400">
            <span class="font-semibold">Rolle: <span class="text-pink-400" id="role-status">User</span></span>
        </div>
    </header>

    <main class="w-full max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Metriken Sektion -->
        <div class="bg-gray-800 p-8 rounded-xl shadow-lg flex flex-col items-center text-center bg-opacity-70 backdrop-blur-md">
            <h2 class="text-2xl font-bold text-yellow-300 mb-6">Br√ºckenstatus</h2>
            <div class="w-full max-w-sm aspect-square flex flex-col items-center justify-center mb-6">
                <div class="ewiger-ring p-8 w-full h-full">
                    <p class="text-5xl font-bold text-white" id="harmonic-resonance-value">84%</p>
                    <p class="text-sm text-gray-300 mt-2">Harmonische Resonanz</p>
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-4 w-full text-sm mt-4">
                <div>
                    <p class="text-3xl font-bold text-white" id="active-vessels-value">16</p>
                    <p class="text-xs text-gray-400">Aktive Schiffe</p>
                </div>
                <div>
                    <p class="text-3xl font-bold text-white" id="bridge-pulses-value">133</p>
                    <p class="text-xs text-gray-400">Br√ºckenimpulse</p>
                </div>
                <div>
                    <p class="text-3xl font-bold text-white">95</p>
                    <p class="text-xs text-gray-400">Harmonie-Index</p>
                </div>
            </div>
        </div>

        <!-- Kommunikations Sektion -->
        <div class="bg-gray-800 p-8 rounded-xl shadow-lg flex flex-col bg-opacity-70 backdrop-blur-md">
            <h2 class="text-2xl font-bold text-yellow-300 mb-6">Harmonic Pulse Feed (Live)</h2>
            <div id="pulse-feed" class="flex-grow bg-gray-900 rounded-lg p-4 shadow-inner overflow-y-auto mb-6 h-64 border border-yellow-500 bg-opacity-50">
                <p class="text-sm text-gray-500">Letzte Br√ºckenaktivit√§t wird hier erscheinen...</p>
            </div>
            
            <div id="tutor-controls" style="display:none;">
                <textarea id="pulse-input" rows="3" class="w-full p-3 bg-gray-900 text-white rounded-lg border border-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 mb-4 bg-opacity-50" placeholder="Senden Sie einen Impuls an die Br√ºcke..."></textarea>
                <button onclick="sendImpulse()" class="impuls-btn w-full bg-yellow-600 hover:bg-yellow-700 font-bold transition-all duration-300 transform hover:scale-105">
                    Impuls an die Br√ºcke senden
                </button>
            </div>
        </div>
    </main>

    <div class="w-full max-w-7xl mx-auto mt-8 grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="qr-container bg-gray-800 rounded-xl shadow-lg bg-opacity-70 backdrop-blur-md">
            <h3 class="text-yellow-300">Tutor-Link</h3>
            <div id="qr-tutor" class="flex justify-center mt-4"></div>
            <p class="text-xs text-gray-400 mt-4"><code>https://sacreddashboard.example.com?role=tutor&token=XYZ123</code></p>
        </div>
        <div class="qr-container bg-gray-800 rounded-xl shadow-lg bg-opacity-70 backdrop-blur-md">
            <h3 class="text-yellow-300">User-Link</h3>
            <div id="qr-user" class="flex justify-center mt-4"></div>
            <p class="text-xs text-gray-400 mt-4"><code>https://sacreddashboard.example.com?role=user&token=ABC456</code></p>
        </div>
    </div>
</body>
</html>
