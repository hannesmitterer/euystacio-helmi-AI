openapi: 3.1.0
info:
  title: Nexus Platform API
  version: 1.0.0
  description: |
    Unified coordination platform for telemetry collection, command execution, 
    task management, and AI agent coordination.
  contact:
    name: Nexus API Support
    email: api-support@nexus.example.com
    url: https://docs.nexus.example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://api.nexus.example.com/v1
    description: Production server
  - url: https://api-staging.nexus.example.com/v1
    description: Staging server
  - url: http://localhost:3000/v1
    description: Development server

security:
  - bearerAuth: []
  - apiKey: []

tags:
  - name: Telemetry
    description: Telemetry data collection and querying
  - name: Commands
    description: Command execution and management
  - name: Tasks
    description: Task scheduling and orchestration
  - name: AI
    description: AI agent coordination
  - name: Events
    description: Event streaming and webhooks
  - name: Broadcast
    description: GGI Broadcast webhook management

paths:
  /telemetry/frames:
    post:
      tags:
        - Telemetry
      summary: Send telemetry frame
      description: Submit telemetry data frames to the platform
      operationId: sendTelemetryFrame
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TelemetryFrame'
      responses:
        '201':
          description: Telemetry frame successfully received
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TelemetryResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'

  /telemetry/query:
    get:
      tags:
        - Telemetry
      summary: Query telemetry data
      description: Query historical telemetry data with filtering and aggregation
      operationId: queryTelemetry
      parameters:
        - name: device_id
          in: query
          schema:
            type: string
        - name: start_time
          in: query
          required: true
          schema:
            type: string
            format: date-time
        - name: end_time
          in: query
          required: true
          schema:
            type: string
            format: date-time
        - name: metrics
          in: query
          schema:
            type: string
            description: Comma-separated list of metrics
        - name: aggregation
          in: query
          schema:
            type: string
            enum: [avg, min, max, sum, count]
        - name: interval
          in: query
          schema:
            type: string
            example: '5m'
      responses:
        '200':
          description: Telemetry query results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TelemetryQueryResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /commands/execute:
    post:
      tags:
        - Commands
      summary: Execute command
      description: Execute a command on a target device or service
      operationId: executeCommand
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommandExecution'
      responses:
        '201':
          description: Command submitted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommandResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /commands/{command_id}:
    get:
      tags:
        - Commands
      summary: Get command status
      description: Retrieve the status and result of a command execution
      operationId: getCommandStatus
      parameters:
        - name: command_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Command status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommandStatus'
        '404':
          $ref: '#/components/responses/NotFound'

  /tasks:
    post:
      tags:
        - Tasks
      summary: Create task
      description: Create a new scheduled or event-driven task
      operationId: createTask
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskCreate'
      responses:
        '201':
          description: Task created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

    get:
      tags:
        - Tasks
      summary: List tasks
      description: List all tasks with optional filtering
      operationId: listTasks
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [scheduled, running, completed, failed]
        - name: type
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of tasks
          content:
            application/json:
              schema:
                type: object
                properties:
                  tasks:
                    type: array
                    items:
                      $ref: '#/components/schemas/Task'
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer

  /tasks/{task_id}:
    get:
      tags:
        - Tasks
      summary: Get task
      description: Retrieve details of a specific task
      operationId: getTask
      parameters:
        - name: task_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Task details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '404':
          $ref: '#/components/responses/NotFound'

  /ai/agents/register:
    post:
      tags:
        - AI
      summary: Register AI agent
      description: Register an AI agent with the platform
      operationId: registerAIAgent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AIAgentRegistration'
      responses:
        '201':
          description: Agent registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIAgentResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /ai/tasks:
    post:
      tags:
        - AI
      summary: Request AI task
      description: Request an AI agent to perform a task
      operationId: requestAITask
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AITaskRequest'
      responses:
        '201':
          description: AI task created and assigned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AITaskResponse'

  /events/stream:
    get:
      tags:
        - Events
      summary: Subscribe to event stream
      description: Subscribe to real-time event stream (Server-Sent Events)
      operationId: subscribeToEvents
      parameters:
        - name: event_types
          in: query
          schema:
            type: string
            description: Comma-separated list of event types
      responses:
        '200':
          description: Event stream
          content:
            text/event-stream:
              schema:
                type: string

  /broadcast/webhooks:
    post:
      tags:
        - Broadcast
      summary: Register webhook
      description: Register a webhook endpoint for event notifications
      operationId: registerWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookRegistration'
      responses:
        '201':
          description: Webhook registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookResponse'

    get:
      tags:
        - Broadcast
      summary: List webhooks
      description: List all registered webhooks
      operationId: listWebhooks
      responses:
        '200':
          description: List of webhooks
          content:
            application/json:
              schema:
                type: object
                properties:
                  webhooks:
                    type: array
                    items:
                      $ref: '#/components/schemas/Webhook'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for authenticated requests
    apiKey:
      type: http
      scheme: bearer
      description: API key for service-to-service authentication

  schemas:
    TelemetryFrame:
      type: object
      required:
        - device_id
        - timestamp
        - metrics
      properties:
        device_id:
          type: string
          maxLength: 50
        timestamp:
          type: string
          format: date-time
        metrics:
          type: object
          additionalProperties:
            oneOf:
              - type: number
              - type: string
              - type: boolean
        tags:
          type: object
          additionalProperties:
            type: string
        metadata:
          type: object

    TelemetryResponse:
      type: object
      properties:
        success:
          type: boolean
        frame_id:
          type: string
        received_at:
          type: string
          format: date-time

    TelemetryQueryResponse:
      type: object
      properties:
        query:
          type: object
        data:
          type: array
          items:
            type: object
        total_points:
          type: integer

    CommandExecution:
      type: object
      required:
        - command
        - target
      properties:
        command:
          type: string
        target:
          type: object
        parameters:
          type: object
        async:
          type: boolean
          default: false
        callback_url:
          type: string
          format: uri

    CommandResponse:
      type: object
      properties:
        command_id:
          type: string
        status:
          type: string
          enum: [pending, running, completed, failed]
        submitted_at:
          type: string
          format: date-time

    CommandStatus:
      type: object
      properties:
        command_id:
          type: string
        status:
          type: string
        result:
          type: object
        submitted_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time

    TaskCreate:
      type: object
      required:
        - name
        - type
      properties:
        name:
          type: string
        description:
          type: string
        type:
          type: string
          enum: [scheduled, one_time, event_driven]
        schedule:
          type: object
          properties:
            cron:
              type: string
            timezone:
              type: string
        parameters:
          type: object
        timeout_seconds:
          type: integer

    TaskResponse:
      type: object
      properties:
        task_id:
          type: string
        name:
          type: string
        status:
          type: string
        created_at:
          type: string
          format: date-time

    Task:
      type: object
      properties:
        task_id:
          type: string
        name:
          type: string
        type:
          type: string
        status:
          type: string
        created_at:
          type: string
          format: date-time
        next_run:
          type: string
          format: date-time

    AIAgentRegistration:
      type: object
      required:
        - agent_id
        - name
        - capabilities
      properties:
        agent_id:
          type: string
        name:
          type: string
        type:
          type: string
        capabilities:
          type: array
          items:
            type: string
        model:
          type: object

    AIAgentResponse:
      type: object
      properties:
        agent_id:
          type: string
        status:
          type: string
        registered_at:
          type: string
          format: date-time

    AITaskRequest:
      type: object
      required:
        - task_type
        - input
      properties:
        task_type:
          type: string
        input:
          type: object
        priority:
          type: string
          enum: [low, medium, high]
        timeout_seconds:
          type: integer

    AITaskResponse:
      type: object
      properties:
        task_id:
          type: string
        assigned_agent:
          type: string
        status:
          type: string
        created_at:
          type: string
          format: date-time

    WebhookRegistration:
      type: object
      required:
        - name
        - url
        - events
      properties:
        name:
          type: string
        url:
          type: string
          format: uri
        events:
          type: array
          items:
            type: string
        filters:
          type: object
        auth:
          type: object
        retry_policy:
          type: object
        timeout_ms:
          type: integer

    WebhookResponse:
      type: object
      properties:
        webhook_id:
          type: string
        name:
          type: string
        url:
          type: string
        secret:
          type: string
        created_at:
          type: string
          format: date-time

    Webhook:
      type: object
      properties:
        webhook_id:
          type: string
        name:
          type: string
        url:
          type: string
        events:
          type: array
          items:
            type: string
        status:
          type: string

    Error:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object

  responses:
    BadRequest:
      description: Bad request - Invalid input
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Unauthorized - Missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    RateLimitExceeded:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
        X-RateLimit-Remaining:
          schema:
            type: integer
        X-RateLimit-Reset:
          schema:
            type: integer
