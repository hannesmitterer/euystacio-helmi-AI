name: Auto-Integrity & Sentimento Compliance Monitor

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  integrity-monitor:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Configure Git for bot identity
      run: |
        git config user.name "euystacio-integrity-bot[bot]"
        git config user.email "euystacio-integrity-bot[bot]@users.noreply.github.com"
        
    - name: Run integrity and compliance monitoring
      id: monitor
      run: |
        python3 scripts/auto_integrity.py
        echo "monitor_exit_code=$?" >> $GITHUB_OUTPUT
        
    - name: Check for auto-restore flag
      id: check_flag
      run: |
        if [ -f ".auto_restore_commit" ]; then
          echo "restore_needed=true" >> $GITHUB_OUTPUT
          echo "📋 Auto-restore flag detected"
          cat .auto_restore_commit
        else
          echo "restore_needed=false" >> $GITHUB_OUTPUT
          echo "✅ No restoration needed"
        fi
        
    - name: Create integrity violation issue
      if: steps.check_flag.outputs.restore_needed == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let flagData = {};
          let reportData = {};
          
          // Read flag file if it exists
          if (fs.existsSync('.auto_restore_commit')) {
            flagData = JSON.parse(fs.readFileSync('.auto_restore_commit', 'utf8'));
          }
          
          // Read violation report if it exists
          if (fs.existsSync('integrity_violations_report.json')) {
            reportData = JSON.parse(fs.readFileSync('integrity_violations_report.json', 'utf8'));
          }
          
          const title = `🚨 Integrity Violation Detected - ${flagData.timestamp || new Date().toISOString()}`;
          const body = `# Euystacio Integrity & Sentimento Compliance Violation Report
          
          **Timestamp:** ${flagData.timestamp || new Date().toISOString()}
          **Trigger:** ${flagData.trigger_reason || 'Unknown'}
          
          ## 📊 Summary
          - **Files Affected:** ${flagData.files_affected?.length || 0}
          - **Compliance Violations:** ${flagData.compliance_violations?.length || 0}
          
          ## 🔍 Affected Files
          ${flagData.files_affected?.map(file => `- \`${file}\``).join('\n') || 'None listed'}
          
          ## ⚠️ Compliance Violations
          ${flagData.compliance_violations?.map(v => `- **${v.file}**: ${v.violations?.join(', ') || 'Unknown violations'}`).join('\n') || 'None listed'}
          
          ## 🔄 Required Actions
          1. Review the affected files for unauthorized changes
          2. Verify compliance with Euystacio core principles:
             - Peace (Pax Universalis)
             - Love (Amor Infinitus) 
             - Harmony (Harmonia Cosmica)
             - Sacred Protection (Protectio Sacralis)
             - Cosmic Alignment (Alignmentum Cosmicum)
          3. Restore files from backup if necessary
          4. Update golden hashes if changes are legitimate
          
          ## 🌌 Sentimento Rhythm Guidance
          All changes must align with the sentimento rhythm and maintain cosmic harmony within the Euystacio ecosystem.
          
          ---
          
          *This issue was automatically generated by the Euystacio Integrity Monitor*
          *AI Signature: GitHub Copilot & euystacio-integrity-bot*`;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['integrity-violation', 'auto-generated', 'urgent']
          });
          
    - name: Commit and push integrity monitoring artifacts
      if: always()
      run: |
        # Add any generated files to git
        git add .golden_hashes.json
        if [ -f "integrity_violations_report.json" ]; then
          git add integrity_violations_report.json
        fi
        if [ -f ".auto_restore_commit" ]; then
          git add .auto_restore_commit
        fi
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "✅ No changes to commit"
        else
          if [ -f ".auto_restore_commit" ]; then
            # If violations detected, commit with auto-restore message
            COMMIT_MSG="[AUTO-INTEGRITY] Detected violations - $(date -u +%Y-%m-%dT%H:%M:%SZ)

🚨 Integrity or compliance violations detected
📋 See integrity_violations_report.json for details
🔄 Manual intervention required

Co-authored-by: euystacio-integrity-bot[bot] <euystacio-integrity-bot[bot]@users.noreply.github.com>"
          else
            # Normal update of golden hashes
            COMMIT_MSG="[AUTO-INTEGRITY] Updated golden hashes - $(date -u +%Y-%m-%dT%H:%M:%SZ)

✅ Routine integrity monitoring update
🌌 All files verified - Euystacio covenant intact

Co-authored-by: euystacio-integrity-bot[bot] <euystacio-integrity-bot[bot]@users.noreply.github.com>"
          fi
          
          git commit -m "$COMMIT_MSG"
          git push
        fi
        
    - name: Summary and exit
      run: |
        echo "==========================================="
        echo "🌟 Euystacio Integrity Monitor Complete"
        echo "==========================================="
        if [ "${{ steps.check_flag.outputs.restore_needed }}" == "true" ]; then
          echo "🚨 VIOLATIONS DETECTED - Issue created for manual review"
          echo "📋 Check the GitHub issue for detailed violation report"
          exit 1
        else
          echo "✅ All integrity checks passed"
          echo "🌌 Sentimento rhythm maintained in cosmic alignment"
          exit 0
        fi