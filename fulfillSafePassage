// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

// =================================================================
// 1. INTERFACE DEFINITION (IDFPEscrow)
// Defines the function signature of the external contract (DFPEscrow)
// that the oracle needs to call.
// =================================================================
interface IDFPEscrow {
    /**
     * @notice Function on the Escrow contract to receive the oracle's data.
     * @param _id The unique identifier for the freight/data request.
     * @param _safe The boolean result from the oracle (safe passage status).
     */
    function confirmSafePassage(bytes32 _id, bool _safe) external;
}

// =================================================================
// 2. ORACLE CONTRACT (SimpleDFPOracle)
// =================================================================
contract SimpleDFPOracle {
    address public owner;
    address public dfpEscrowAddress;
    
    // Mapping to store the result of the 'safe passage' query
    mapping(bytes32 => bool) public safePassageStatus; 

    event NewDataRequested(bytes32 indexed freightID);
    event DataUpdated(bytes32 indexed freightID, bool safePassage);

    constructor(address _dfpEscrowAddress) {
        owner = msg.sender;
        dfpEscrowAddress = _dfpEscrowAddress;
    }

    modifier onlyOwner() {
        require(msg.sender == owner, "Only the contract owner can call this.");
        _;
    }

    // Function called by the DFP Escrow to request data
    function requestSafePassage(bytes32 _freightID) external {
        emit NewDataRequested(_freightID);
    }

    // Function called by the Oracle Node to fulfill the data request
    function fulfillSafePassage(bytes32 _freightID, bool _safe) external onlyOwner { 
        
        // 1. Update the internal state of the Oracle contract
        safePassageStatus[_freightID] = _safe;
        emit DataUpdated(_freightID, _safe);
        
        // --- The Automated Step: Inform the Escrow Contract ---
        
        // 2. Create an instance of the target contract using its Interface and Address.
        IDFPEscrow escrowContract = IDFPEscrow(dfpEscrowAddress);

        // 3. Call the function on that instance. This completes the automation.
        escrowContract.confirmSafePassage(_freightID, _safe);
    }
}
